---
phase: 05-sanity-cms-integration
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - astro.config.mjs
  - src/lib/sanity/client.ts
  - src/lib/sanity/queries.ts
  - src/lib/sanity/imageBuilder.ts
  - src/pages/blog/[slug].astro
  - src/pages/blog/[...page].astro
  - src/layouts/BlogLayout.astro
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Blog index page fetches posts from Sanity"
    - "Blog post pages render Portable Text content"
    - "Featured images display using Sanity CDN URLs"
    - "Build succeeds with Sanity data source"
  artifacts:
    - path: "astro.config.mjs"
      provides: "@sanity/astro integration"
      contains: "sanity("
    - path: "src/lib/sanity/client.ts"
      provides: "Sanity client with useCdn: false"
      contains: "useCdn: false"
    - path: "src/lib/sanity/queries.ts"
      provides: "GROQ queries for blog posts"
      exports: ["blogPostsQuery", "blogPostBySlugQuery"]
    - path: "src/pages/blog/[slug].astro"
      provides: "Dynamic blog post route using Sanity"
      contains: "getStaticPaths"
  key_links:
    - from: "src/pages/blog/[slug].astro"
      to: "src/lib/sanity/client.ts"
      via: "sanityClient import"
      pattern: "sanity:client"
    - from: "src/pages/blog/[slug].astro"
      to: "astro-portabletext"
      via: "PortableText component"
      pattern: "PortableText"
    - from: "src/layouts/BlogLayout.astro"
      to: "src/lib/sanity/imageBuilder.ts"
      via: "urlFor helper"
      pattern: "urlFor"
---

<objective>
Connect Astro to Sanity for dynamic blog rendering, replacing markdown content collections.

Purpose: Replace static markdown blog with Sanity-powered content while maintaining existing visual styling and BlogPostingSchema integration.

Output:
- `@sanity/astro` configured in astro.config.mjs
- Sanity client with GROQ queries
- Blog pages fetching from Sanity instead of content collections
- Portable Text rendering for blog post body
- Image URL builder for featured images
</objective>

<execution_context>
@/Users/thuijsmans/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thuijsmans/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-sanity-cms-integration/05-RESEARCH.md
@.planning/phases/05-sanity-cms-integration/05-01-SUMMARY.md

@src/pages/blog/[...id].astro
@src/pages/blog/[...page].astro
@src/layouts/BlogLayout.astro
@src/components/blocks/blog/PostCards.astro
@astro.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure @sanity/astro integration</name>
  <files>astro.config.mjs, src/lib/sanity/client.ts, src/lib/sanity/queries.ts, src/lib/sanity/imageBuilder.ts</files>
  <action>
**1. Update astro.config.mjs:**

Add @sanity/astro integration after existing integrations:

```javascript
import sanity from '@sanity/astro'

// In integrations array, add:
sanity({
  projectId: 'pbui2f8s',
  dataset: 'production',
  useCdn: false,  // CRITICAL: false for SSG builds to avoid stale content
  perspective: 'published',
  apiVersion: '2025-02-19',
}),
```

Keep all existing integrations (icon, sitemap, lottie, partytown, react, markdoc, vercel adapter).

**2. Create src/lib/sanity/client.ts:**

```typescript
// Re-export sanity client from the integration
// Client is configured via astro.config.mjs
export { sanityClient } from 'sanity:client'
```

**3. Create src/lib/sanity/queries.ts:**

```typescript
// GROQ queries for blog content
// Always filter for defined(slug.current) to prevent build errors

export const blogPostsQuery = `*[_type == "post" && defined(slug.current)] | order(publishedAt desc) {
  _id,
  title,
  "slug": slug.current,
  publishedAt,
  author,
  category,
  "imageUrl": featuredImage.asset->url,
  "imageAlt": featuredImage.alt
}`

export const blogPostBySlugQuery = `*[_type == "post" && slug.current == $slug][0] {
  _id,
  title,
  "slug": slug.current,
  publishedAt,
  author,
  category,
  featuredImage,
  "imageUrl": featuredImage.asset->url,
  body
}`
```

**4. Create src/lib/sanity/imageBuilder.ts:**

```typescript
import imageUrlBuilder from '@sanity/image-url'
import { sanityClient } from 'sanity:client'
import type { SanityImageSource } from '@sanity/image-url/lib/types/types'

const builder = imageUrlBuilder(sanityClient)

export function urlFor(source: SanityImageSource) {
  return builder.image(source)
}
```
  </action>
  <verify>
- `grep -l "sanity(" astro.config.mjs` finds the integration
- `cat src/lib/sanity/client.ts` exports sanityClient
- `cat src/lib/sanity/queries.ts` contains both queries with defined() filter
- `npm run build` starts without configuration errors (may fail if no content yet)
  </verify>
  <done>Sanity integration configured in Astro with client, queries, and image builder ready for use</done>
</task>

<task type="auto">
  <name>Task 2: Replace blog pages with Sanity fetching</name>
  <files>src/pages/blog/[slug].astro, src/pages/blog/[...page].astro, src/layouts/BlogLayout.astro</files>
  <action>
**1. Replace src/pages/blog/[...id].astro with src/pages/blog/[slug].astro:**

Delete `[...id].astro` and create `[slug].astro`:

```astro
---
// Blog Post Page - Sanity Powered
import { sanityClient } from 'sanity:client'
import { PortableText } from 'astro-portabletext'
import Layout from '../../layouts/BlogLayout.astro'
import { blogPostsQuery, blogPostBySlugQuery } from '../../lib/sanity/queries'

export async function getStaticPaths() {
  const posts = await sanityClient.fetch(blogPostsQuery)
  return posts.map((post: any) => ({
    params: { slug: post.slug },
    props: { post },
  }))
}

interface Props {
  post: {
    _id: string
    title: string
    slug: string
    publishedAt: string
    author: string
    category: string
    featuredImage?: any
    imageUrl?: string
    body: any[]
  }
}

const { post } = Astro.props

// Fetch full post data including body (list query doesn't include body for performance)
const fullPost = await sanityClient.fetch(blogPostBySlugQuery, { slug: post.slug })
---

<Layout frontmatter={{
  title: fullPost.title,
  description: '', // Sanity doesn't have description field per user decision
  pubDate: fullPost.publishedAt,
  author: fullPost.author,
  image: fullPost.imageUrl || undefined,
}}>
  <PortableText value={fullPost.body} />
</Layout>
```

**2. Update src/pages/blog/[...page].astro:**

Replace content collection with Sanity query:

```astro
---
// Blog Page - Sanity Powered
import Layout from '../../layouts/Layout.astro'
import Hero from '../../components/blocks/hero/SimpleHeroBasic.astro'
import Section from '../../components/ui/Section.astro'
import Row from '../../components/ui/Row.astro'
import Col from '../../components/ui/Col.astro'
import BlogCard from '../../components/ui/cards/BlogCard.astro'
import { sanityClient } from 'sanity:client'
import { blogPostsQuery } from '../../lib/sanity/queries'

// For SSG, we need getStaticPaths even for index
export async function getStaticPaths({ paginate }: any) {
  const posts = await sanityClient.fetch(blogPostsQuery)
  return paginate(posts, { pageSize: 100 })
}

const { page } = Astro.props as any

const SEO = {
  title: 'PromptMarketing | Blog',
  description: 'Read the latest insights on Relevance Engineering, AI-readiness, and how brands can become machine-trustworthy in the age of agentic commerce.'
}
---

<Layout title={SEO.title} description={SEO.description}>
  <Hero
    subtitle="Insights & Ideas"
    title="Fresh perspectives from the team"
    text="Stay up to date with the latest articles, resources, and practical tips. Our blog covers AI Search, innovation in LLMs, Agentic Commerce and everything in between."
  />
  <Section>
    <Row>
      {page.data.map((post: any, index: number) => (
        <Col span={index === 0 || index === 1 ? '6' : '4'}>
          <BlogCard
            title={post.title}
            image={index < 2 && post.imageUrl ? post.imageUrl : ''}
            link={`/blog/${post.slug}`}
            date={new Date(post.publishedAt).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
            author={post.author}
            description=""
            classes="h-full"
          />
        </Col>
      ))}
    </Row>
  </Section>
</Layout>
```

Note: Inlined PostCards logic since we're changing the data shape. Original PostCards used `post.data.title` pattern from content collections; Sanity uses flat `post.title`.

**3. Update src/layouts/BlogLayout.astro:**

Update to handle Sanity image URLs (strings) vs content collection image imports:

- Keep existing layout structure
- Update Image component to handle string URLs from Sanity CDN
- Keep BlogPostingSchema integration (it already accepts image as string)

The layout already accepts `frontmatter.image` as a string path. For Sanity images, we'll pass the CDN URL directly. Update the Image component usage:

```astro
{frontmatter.image && (
  <Section>
    <Row>
      <Col span="12">
        <div class="parallax h-96 w-full lg:h-[680px]">
          <img
            class="h-[calc(100%+50px)] w-full object-cover will-change-transform"
            src={frontmatter.image}
            alt={frontmatter.title}
            width="1920"
            height="1080"
            loading="lazy"
            decoding="async"
          />
        </div>
      </Col>
    </Row>
  </Section>
)}
```

Replace `Image` from `astro:assets` with standard `img` tag since Sanity CDN URLs are external. The Sanity CDN handles optimization.
  </action>
  <verify>
- `ls src/pages/blog/` shows `[slug].astro` and `[...page].astro` (no `[...id].astro`)
- `grep -l "sanity:client" src/pages/blog/*.astro` finds both blog pages
- `grep -l "PortableText" src/pages/blog/[slug].astro` confirms Portable Text import
- Blog pages import from `../../lib/sanity/queries`
  </verify>
  <done>Blog pages fetch from Sanity, render Portable Text content, and display Sanity CDN images</done>
</task>

</tasks>

<verification>
- [ ] `astro.config.mjs` includes sanity integration with useCdn: false
- [ ] `src/lib/sanity/` directory contains client.ts, queries.ts, imageBuilder.ts
- [ ] `src/pages/blog/[slug].astro` exists and uses getStaticPaths with Sanity
- [ ] `src/pages/blog/[...page].astro` fetches from Sanity instead of content collection
- [ ] Old `[...id].astro` is deleted
- [ ] BlogLayout.astro handles external image URLs
- [ ] GROQ queries filter for `defined(slug.current)` (prevents build errors)
</verification>

<success_criteria>
Astro blog pages are fully wired to Sanity. Build will succeed once content exists in Sanity. Layout maintains existing visual styling and BlogPostingSchema integration. Ready for Studio deployment and content seeding in Plan 03.
</success_criteria>

<output>
After completion, create `.planning/phases/05-sanity-cms-integration/05-02-SUMMARY.md`
</output>
