---
phase: 05-sanity-cms-integration
plan: 04
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/content.config.ts
  - src/pages/blog/[...id].astro
autonomous: false
user_setup:
  - service: vercel
    why: "Deployment platform for site rebuilds"
    dashboard_config:
      - task: "Create Deploy Hook for Sanity webhook"
        location: "Vercel Dashboard -> Project Settings -> Git -> Deploy Hooks"
  - service: sanity
    why: "Webhook to trigger rebuilds on publish"
    dashboard_config:
      - task: "Create webhook pointing to Vercel Deploy Hook URL"
        location: "Sanity Dashboard -> API -> Webhooks"

must_haves:
  truths:
    - "Markdown blog infrastructure is removed"
    - "Publishing in Sanity triggers site rebuild"
    - "Content collection only contains portfolio (not blog)"
  artifacts:
    - path: "src/content.config.ts"
      provides: "Content collections without blog"
      contains: "portfolio"
  key_links:
    - from: "Sanity webhook"
      to: "Vercel Deploy Hook"
      via: "HTTP POST on publish"
      pattern: "N/A - external services"
---

<objective>
Remove markdown blog infrastructure and configure automatic rebuilds when content is published in Sanity.

Purpose: Complete the migration from markdown to Sanity by removing obsolete files and establishing the rebuild workflow so client edits trigger automatic deployments.

Output:
- Markdown blog content deleted
- Blog content collection removed from config
- Vercel Deploy Hook created
- Sanity webhook configured to trigger rebuilds on publish
</objective>

<execution_context>
@/Users/thuijsmans/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thuijsmans/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-sanity-cms-integration/05-CONTEXT.md
@.planning/phases/05-sanity-cms-integration/05-02-SUMMARY.md
@src/content.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove markdown blog infrastructure</name>
  <files>src/content.config.ts</files>
  <action>
**1. Delete markdown blog content:**

```bash
rm -rf src/content/blog/
```

This removes all placeholder markdown posts. Per user decision, these are placeholders not real content.

**2. Update src/content.config.ts:**

Remove the blog collection, keep only portfolio:

```typescript
import { z, defineCollection } from 'astro:content'
import { glob } from 'astro/loaders'

const portfolio = defineCollection({
  loader: glob({ pattern: '**/[^_]*.{md,mdx}', base: './src/content/portfolio' }),
  schema: () =>
    z.object({
      title: z.string(),
      client: z.string(),
      pubDate: z.date(),
      description: z.string(),
      challenge: z.string(),
      solution: z.string(),
      results: z.array(z.string()),
      image: z.string().optional(),
      thumbnail: z.string().optional()
    })
})

export const collections = {
  portfolio
}
```

**3. Delete old blog page route (if still exists):**

```bash
rm -f src/pages/blog/[...id].astro
```

This ensures only the new `[slug].astro` route exists.

**4. Verify build still works:**

```bash
npm run build
```

Build should succeed using Sanity data (from Plan 03).
  </action>
  <verify>
- `ls src/content/` shows only `portfolio/` directory
- `grep -c "blog" src/content.config.ts` returns 0
- `ls src/pages/blog/` shows only `[slug].astro` and `[...page].astro`
- `npm run build` succeeds
  </verify>
  <done>Markdown blog infrastructure removed, content collection simplified to portfolio only</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure Vercel Deploy Hook and Sanity Webhook</action>
  <instructions>
**Step 1: Create Vercel Deploy Hook**

1. Go to Vercel Dashboard
2. Select the prompt-marketing project
3. Navigate to: Settings -> Git -> Deploy Hooks
4. Click "Create Hook"
5. Name: `Sanity Content Publish`
6. Branch: `main`
7. Click "Create Hook"
8. Copy the generated URL (looks like: `https://api.vercel.com/v1/integrations/deploy/...`)

**Step 2: Create Sanity Webhook**

1. Go to Sanity Dashboard: https://www.sanity.io/manage/project/pbui2f8s
2. Navigate to: API -> Webhooks
3. Click "Create webhook"
4. Configure:
   - Name: `Vercel Deploy`
   - URL: [paste Vercel Deploy Hook URL from Step 1]
   - Dataset: `production`
   - Trigger on: `Create`, `Update`, `Delete`
   - Filter: `_type == "post" && !(_id in path("drafts.**"))`
     (This ensures only published posts trigger rebuilds, not draft saves)
   - HTTP method: `POST`
   - HTTP headers: (none needed)
   - Secret: (optional, can leave blank)
5. Click "Save"

**Step 3: Test the webhook**

1. Go to Sanity Studio: https://promptmarketing.sanity.studio
2. Edit any blog post (change a word)
3. Click "Publish"
4. Check Vercel Dashboard -> Deployments
5. Confirm a new deployment was triggered
  </instructions>
  <why>Vercel Deploy Hooks and Sanity webhooks require dashboard configuration that cannot be done via CLI. This connects content publishing to site deployment.</why>
  <resume-signal>Type "webhook configured" after completing the steps and confirming a test deployment was triggered</resume-signal>
</task>

</tasks>

<verification>
- [ ] `src/content/blog/` directory does not exist
- [ ] `src/content.config.ts` only exports portfolio collection
- [ ] No `[...id].astro` file in blog directory
- [ ] Vercel Deploy Hook exists for main branch
- [ ] Sanity webhook points to Vercel Deploy Hook URL
- [ ] Webhook filter excludes draft documents
- [ ] Test publish in Sanity triggers Vercel deployment
</verification>

<success_criteria>
Migration complete. Markdown blog removed. Automatic rebuild workflow operational. When client publishes in Sanity Studio, site automatically rebuilds and deploys with fresh content.
</success_criteria>

<output>
After completion, create `.planning/phases/05-sanity-cms-integration/05-04-SUMMARY.md`
</output>
